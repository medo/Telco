---
title: "Traffic Data Analysis"
output: html_document
---

```{r}
library(ggplot2)
library(tidyr)
library(dplyr)
library(knitr)
library(caret)
library(corrgram)
library(pROC)
library(plyr)
```

```{r}
roaming_data <- read.csv("data/roaming_monthly.csv")
contract_data <- read.csv("data/contract_clean.csv")
test_data <- read.csv("data/test.csv")
train_data <- read.csv("data/train.csv")
daily_aggregate <- read.csv("data/daily_aggregate.csv")

train_data <- train_data %>% mutate(TARGET=as.factor(TARGET)) 
```

```{r}
fitControl <- trainControl(method = "repeatedcv",
                           number = 3,
                           repeats = 1,
                           savePredictions = TRUE,
                           classProbs = TRUE,
                           summaryFunction= twoClassSummary,
                           returnResamp='none',
                           allowParallel = TRUE
                          )

train_model <- function(data, method, grid){

  model <- train(data %>% dplyr::select(-TARGET,-CONTRACT_KEY), (data %>% dplyr::select(TARGET))[,1], method=method, trControl = fitControl, tuneGrid = grid, metric="ROC", verbose=F)
}

predict_and_create_submission <- function(model, test_data){
  
  test_data_without_contract_key <- test_data %>% dplyr::select(-CONTRACT_KEY)
  CONTRACT_KEYS <- test_data %>% dplyr::select(CONTRACT_KEY)
  predictions <- predict(model, test_data_without_contract_key)
  
  predictions <- predictions %>% sapply(function(x){return(ifelse(x == "X0", 0,1))})
  
  submission <- data.frame(
    CONTRACT_KEY = CONTRACT_KEYS,
    PREDICTED_TARGET = predictions
  )
  
  write.csv(submission,quote=FALSE,row.names=FALSE, file= paste("submissions/", Sys.time(), ".csv", sep=""))
  
  return(submission)
}

evaluate_on_all_models <- function(data) {
  
  return(c("xgbTree", "gbm", "treebag", "nb", "rf") %>% lapply(function(algo){
    print(algo)
    m <- train_model(data , algo, NULL)
    auc <- auc(as.numeric(m$pred$obs), as.numeric(m$pred$pred))
    print(auc)
    
    return(list(
      model = m,
      auc = auc
    ))
  }))
}
```

```{r}
prepare_roaming_data <- function(data){
  
  ret_data <- data %>% mutate(CALL_MONTH_KEY=paste("USAGE_", CALL_MONTH_KEY, sep="")) %>% spread(CALL_MONTH_KEY, USAGE, 0) %>% mutate(SESSIONS_206 = ifelse(USAGE_206 > 0, SESSION_COUNT, 0),SESSIONS_207 = ifelse(USAGE_207 > 0, SESSION_COUNT, 0),SESSIONS_208 = ifelse(USAGE_208 > 0, SESSION_COUNT, 0),SESSIONS_209 = ifelse(USAGE_209 > 0, SESSION_COUNT, 0),SESSIONS_210 = ifelse(USAGE_210 > 0, SESSION_COUNT, 0)) %>% ddply(.(CONTRACT_KEY), summarize, USAGE_206=sum(USAGE_206), USAGE_207=sum(USAGE_207), USAGE_208=sum(USAGE_208), USAGE_209=sum(USAGE_209), USAGE_210=sum(USAGE_210), SESSIONS_206=sum(SESSIONS_206), SESSIONS_207=sum(SESSIONS_207), SESSIONS_208=sum(SESSIONS_208), SESSIONS_209=sum(SESSIONS_209), SESSIONS_210=sum(SESSIONS_210))
  
  return(ret_data)
}

```

```{r}
train_data <- train_data %>% sample_n(100)
```

```{r}
prepare_dataset <- function(data, is_train) {
  
  # Adding contract data
  ret_data <- inner_join(data, contract_data, by="CONTRACT_KEY") 
  
  # Adding roaming data
  #roaming_data_tmp <- prepare_roaming_data(roaming_data)
  #ret_data <- left_join(ret_data, roaming_data_tmp, by="CONTRACT_KEY")
  #ret_data$SESSIONS_206[is.na(ret_data$SESSIONS_206)] = 0
  #ret_data$SESSIONS_207[is.na(ret_data$SESSIONS_207)] = 0
  #ret_data$SESSIONS_208[is.na(ret_data$SESSIONS_208)] = 0
  #ret_data$SESSIONS_209[is.na(ret_data$SESSIONS_209)] = 0
  #ret_data$SESSIONS_210[is.na(ret_data$SESSIONS_210)] = 0
  #ret_data$USAGE_206[is.na(ret_data$USAGE_206)] = 0
  #ret_data$USAGE_207[is.na(ret_data$USAGE_207)] = 0
  #ret_data$USAGE_208[is.na(ret_data$USAGE_208)] = 0
  #ret_data$USAGE_209[is.na(ret_data$USAGE_209)] = 0
  #ret_data$USAGE_210[is.na(ret_data$USAGE_210)] = 0
  
  
  ret_data <- ret_data %>% dplyr::select(-X, -HANDSET_NAME, -RATE_PLAN)
  
  # FIXING THE AGE
  ret_data[ret_data$AGE == 99,]$AGE <- (ret_data[ret_data$AGE != 99,]$AGE %>% median)
  
  # One hot encoding
  ret_data <- model.matrix(~. -1, data=ret_data, fullRank=F) %>% as.data.frame
  
  # Adding Some cols
  ret_data <- ret_data %>% mutate(USAGE_DIFF=X210_USAGE-X206_USAGE)
  ret_data <- ret_data %>% mutate(USAGE_EXPECTED=(X210_USAGE-X206_USAGE)/5 + X210_USAGE)
  ret_data <- ret_data %>% mutate(USAGE_MEAN=(X206_USAGE+X207_USAGE+X208_USAGE+X209_USAGE+X210_USAGE)/5)
  
  # Drop UNNEEDED COLUMNS/ Highly correlated
  #ret_data <- ret_data %>% dplyr::select(-ends_with("_SESSION_COUNT"))
  #ret_data <- ret_data %>% dplyr::select(-starts_with("SESSIONS_"))
  #ret_data <- ret_data %>% dplyr::select(-matches("X2"))
  
  # Removing Outliers from train data
  if(is_train){
    ret_data <- ret_data %>% filter(USAGE_MEAN <= 15000)
  }
  
  
  if("TARGET1" %in% names(ret_data)){
    ret_data <- ret_data %>% mutate(TARGET=as.factor(TARGET1)) %>% dplyr::select(-TARGET1,-TARGET0)
    levels(ret_data$TARGET) <- make.names(levels(factor(ret_data$TARGET)))
  }
  
  return(ret_data)
}

train_transformed_data <- prepare_dataset(train_data, TRUE)
test_transformed_data <- prepare_dataset(test_data, FALSE)

train_transformed_data %>%str
```

```{r}
models <- evaluate_on_all_models(train_transformed_data)
#m <- train_model(train_transformed_data , "gbm", NULL)
#auc <- auc(as.numeric(m$pred$obs), as.numeric(m$pred$pred))
#submission <- predict_and_create_submission(m, test_transformed_data)
```

```{r}
tcc <- cor(train_transformed_data %>% dplyr::select(-CONTRACT_KEY) %>% mutate(TARGET=as.numeric(TARGET)))
corrplot::corrplot(tcc)

# Feature Correlation with target
(tcc["TARGET", ] %>% as.list)[order(unlist(tcc["TARGET", ] %>% as.list),decreasing=TRUE)]
```