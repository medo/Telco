---
title: "Traffic Data Analysis"
output: html_document
---

```{r}
library(ggplot2)
library(tidyr)
library(dplyr)
library(knitr)
library(caret)
library(corrgram)
library(pROC)
library(plyr)
library(doMC)
registerDoMC(cores = 4)
```

```{r}
train_model <- function(data, method){
  
  t <- list(
    obs= data %>% dplyr::select(-TARGET,-CONTRACT_KEY),
    class= (data %>% dplyr::select(TARGET))[,1]
  )

  set.seed(1234556)
  model <- train(
    x= t$obs,
    y= t$class,
    metric="ROC",
    preProcess=c( "center", "scale"),
    method=method,
    trControl = trainControl(method = "repeatedcv",
                             repeats = 3 ,
                             classProbs = TRUE,
                             savePredictions = "final",
                             summaryFunction= twoClassSummary,
                             allowParallel = TRUE
    )
  )
  
  return(model)
}

predict_and_create_submission <- function(model, test_data){
  
  test_data_without_contract_key <- test_data %>% dplyr::select(-CONTRACT_KEY)
  CONTRACT_KEYS <- (test_data %>% dplyr::select(CONTRACT_KEY))[,1] %>% as.factor
  predictions <- predict(model, test_data_without_contract_key)
  
  predictions <- predictions %>% sapply(function(x){return(ifelse(x == "X0", 0,1))})
  
  submission <- data.frame(
    CONTRACT_KEY = CONTRACT_KEYS,
    PREDICTED_TARGET = predictions
  )
  
  write.csv(submission,quote=FALSE,row.names=FALSE, file= paste("submissions/", Sys.time(), ".csv", sep=""))
  
  return(submission)
}

train_many_models <- function(data, models){
  ret <- models %>% lapply(function(model){
    m <- train_model(data, model)
    print(m)
    return(m)
  })
  names(ret) <- models
  return(ret)
}
```


```{r}
roaming_data <- read.csv("data/roaming_monthly.csv")
contract_data <- read.csv("data/contract_clean.csv")
test_data <- read.csv("data/test.csv")
train_data <- read.csv("data/train.csv")
daily_aggregate <- read.csv("data/daily_aggregate.csv")

train_data <- train_data %>% mutate(TARGET=as.factor(TARGET)) 
```

```{r}
train_data <- train_data %>% sample_n(10000)
```


```{r}
prepare_dataset <- function(data, is_train) {
  
  # Adding contract data
  ret_data <- inner_join(data, contract_data, by="CONTRACT_KEY") 
  
  ret_data <- ret_data %>% dplyr::select(-X, -HANDSET_NAME)
  
  # FIXING THE AGE
  ret_data[ret_data$AGE == 99,]$AGE <- (ret_data[ret_data$AGE != 99,]$AGE %>% median)
  
  # One hot encoding
  ret_data <- model.matrix(~. -1, data=ret_data, fullRank=F) %>% as.data.frame
  
  # Adding Some cols
  ret_data <- ret_data %>% mutate(USAGE_EXPECTED_1=(X210_USAGE-X206_USAGE)/5 + X210_USAGE)
  ret_data <- ret_data %>% mutate(USAGE_MEAN=(X206_USAGE+X207_USAGE+X208_USAGE+X209_USAGE+X210_USAGE)/5)
  
  if(is_train){
    # Drop UNNEEDED COLUMNS
    #ret_data <- ret_data %>% dplyr::select(-ends_with("_SESSION_COUNT"))
    #ret_data <- ret_data %>% dplyr::select(-starts_with("SESSIONS_"))
    #ret_data <- ret_data %>% dplyr::select(-matches("X2"))
    
    ret_data <- ret_data %>% mutate(TARGET=as.factor(TARGET1)) %>% dplyr::select(-TARGET1,-TARGET0)
    levels(ret_data$TARGET) <- make.names(levels(factor(ret_data$TARGET)))
    
    # Removing almost zero variance variables
    nzv <- nearZeroVar(ret_data, names=TRUE)
    nzv <- nzv [! nzv %in% c("TARGET")]
    ret_data <- ret_data %>% dplyr::select(-one_of(nzv))
    
    # Removing highly correlated features
    descrCor <- cor(ret_data %>% dplyr::select(-TARGET))
    highlyCorDescr <- findCorrelation(descrCor, cutoff = .90, names=TRUE)
    ret_data <- ret_data %>% dplyr::select(-one_of(highlyCorDescr))
    
    # Removing linearly corelated values
    lc <- findLinearCombos(ret_data %>% dplyr::select(-TARGET))
    
    if(!is.null(lc$remove)){
      ret_data <- ret_data[, -lc$remove]
    }
  }
  
  return(ret_data)
}

train_transformed_data <- prepare_dataset(train_data, TRUE)
test_transformed_data <- prepare_dataset(test_data, FALSE)
test_transformed_data <- test_transformed_data[, names(test_transformed_data) %in% (train_transformed_data %>% names)]

train_transformed_data %>%str
```


```{r}
models <- train_many_models(train_transformed_data, c("nb"))
#p <- predict(models$nb, train_transformed_data %>% dplyr::select(-TARGET,-CONTRACT_KEY))

confusionMatrix(as.numeric(models$nb$pred$pred), as.numeric(models$nb$pred$obs))
auc(as.numeric(models$nb$pred$obs), as.numeric(models$nb$pred$pred))
#submission <- predict_and_create_submission(models$nb, test_transformed_data)
```