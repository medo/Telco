---
title: "Traffic Data Analysis"
output: html_document
---

```{r}
library(ggplot2)
library(tidyr)
library(dplyr)
library(knitr)
library(caret)
library(corrgram)
library(pROC)
library(plyr)
library(caretEnsemble)
library(doMC)
registerDoMC(cores = 4)
```

```{r}
train_model <- function(data, methods){
  
  t <- list(
    obs= data %>% dplyr::select(-TARGET,-CONTRACT_KEY),
    class= (data %>% dplyr::select(TARGET))[,1]
  )

  set.seed(1234556)
  models <- caretList(
    x= t$obs,
    y= t$class,
    metric="ROC",
    preProcess=c( "center", "scale"),
    methodList = methods,
    continue_on_fail = T,
    trControl = trainControl(method = "repeatedcv",
                             number=5,
                             repeats = 3 ,
                             classProbs = TRUE,
                             savePredictions = "final",
                             summaryFunction= twoClassSummary,
                             allowParallel = TRUE
    )
  )
  
  return(models)
}

predict_and_create_submission <- function(model, test_data){
  
  test_data_without_contract_key <- test_data %>% dplyr::select(-CONTRACT_KEY)
  CONTRACT_KEYS <- (test_data %>% dplyr::select(CONTRACT_KEY))[,1] %>% as.factor
  predictions <- predict(model, test_data_without_contract_key)
  
  predictions <- predictions %>% sapply(function(x){return(ifelse(x == "X0", 0,1))})
  
  submission <- data.frame(
    CONTRACT_KEY = CONTRACT_KEYS,
    PREDICTED_TARGET = predictions
  )
  
  write.csv(submission,quote=FALSE,row.names=FALSE, file= paste("submissions/", Sys.time(), ".csv", sep=""))
  
  return(submission)
}
```


```{r}
roaming_data <- read.csv("data/roaming_monthly.csv")
contract_data <- read.csv("data/contract_clean.csv")
test_data <- read.csv("data/test.csv")
train_data <- read.csv("data/train.csv")
daily_aggregate <- read.csv("data/daily_aggregate.csv")

full_train_data <- inner_join(train_data, contract_data, by="CONTRACT_KEY") 
full_train_data <- full_train_data %>% dplyr::select(-X)
full_train_data <- model.matrix(~. -1, data=full_train_data, fullRank=F) %>% as.data.frame
full_train_data <- full_train_data %>% mutate(TARGET=as.factor(TARGET))
levels(full_train_data$TARGET) <- make.names(levels(factor(full_train_data$TARGET)))


full_test_data <- inner_join(test_data, contract_data, by="CONTRACT_KEY") 
full_test_data <- full_test_data %>% dplyr::select(-X)
full_test_data <- model.matrix(~. -1, data=full_test_data, fullRank=F) %>% as.data.frame
```


```{r}
strain_data <- full_train_data
parts <- createDataPartition(strain_data$TARGET, p=0.3, list=F)
strain_data <- strain_data[parts,]
rm(parts)
```


```{r}
prepare_dataset <- function(data, is_train) {
  ret_data <- data
  
  # FIXING THE AGE
  ret_data[ret_data$AGE == 99,]$AGE <- (ret_data[ret_data$AGE != 99,]$AGE %>% median)
  
  
  # Adding Some cols
  ret_data <- ret_data %>% mutate(USAGE_EXPECTED_1=(X210_USAGE-X206_USAGE)/5 + X210_USAGE)
  ret_data <- ret_data %>% mutate(USAGE_MEAN=(X206_USAGE+X207_USAGE+X208_USAGE+X209_USAGE+X210_USAGE)/5)
  
  if(is_train){
    # Drop UNNEEDED COLUMNS
    #ret_data <- ret_data %>% dplyr::select(-ends_with("_SESSION_COUNT"))
    #ret_data <- ret_data %>% dplyr::select(-starts_with("SESSIONS_"))
    #ret_data <- ret_data %>% dplyr::select(-matches("X2"))
    
    
    # Removing almost zero variance variables
    nzv <- nearZeroVar(ret_data, names=TRUE)
    nzv <- nzv [! nzv %in% c("TARGET")]
    ret_data <- ret_data %>% dplyr::select(-one_of(nzv))
    
    # Removing highly correlated features
    descrCor <- cor(ret_data %>% dplyr::select(-TARGET))
    highlyCorDescr <- findCorrelation(descrCor, cutoff = .90, names=TRUE)
    ret_data <- ret_data %>% dplyr::select(-one_of(highlyCorDescr))
    
    # Removing linearly corelated values
    lc <- findLinearCombos(ret_data %>% dplyr::select(-TARGET))
    
    if(!is.null(lc$remove)){
      ret_data <- ret_data[, -lc$remove]
    }
  }
  
  return(ret_data)
}

train_transformed_data <- prepare_dataset(strain_data, TRUE)
test_transformed_data <- prepare_dataset(full_test_data, FALSE)
test_transformed_data <- test_transformed_data[, names(test_transformed_data) %in% (train_transformed_data %>% names)]

train_transformed_data %>%str
```


```{r}
models <- train_model(train_transformed_data, c("nb","rf", "knn", "glm","xgbTree", "gbm"))
#p <- predict(models$nb, train_transformed_data %>% dplyr::select(-TARGET,-CONTRACT_KEY))

models %>% sapply(function(x){
  print(x$method)
  print(auc(as.numeric(x$pred$obs), as.numeric(x$pred$pred)))
})

submission <- predict_and_create_submission(models$nb, test_transformed_data)
```